

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. Enable Reverse Proxy &mdash; Open OnDemand 2.1.0 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Customizations" href="../../../../customizations.html" />
    <link rel="prev" title="2. Modify Cluster Configuration" href="modify-cluster-configuration.html" />
 
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34776817-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34776817-3');
</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/add-cluster-config.html">Cluster Configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../setup.html">Setup Interactive Apps</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="software-requirements.html">1. Software Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="modify-cluster-configuration.html">2. Modify Cluster Configuration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">3. Enable Reverse Proxy</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">3.1. Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#steps-to-enable-in-apache">3.2. Steps to Enable in Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verify-it-works">3.3. Verify it Works</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">How-Tos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../customizations.html">Customizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../debug.html">Debugging and Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../enable-desktops.html">Enable Interactive Desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../app-development.html">App Development</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install-ihpc-apps.html">Install Other Interactive Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/tutorials-interactive-apps.html">Tutorials: Interactive Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/tutorials-passenger-apps.html">Tutorials: Passenger Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">More</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release-notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../issues/overview.html">OnDemand’s Known Issues</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Open OnDemand</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../setup.html">Setup Interactive Apps</a> &raquo;</li>
        
      <li><span class="section-number">3. </span>Enable Reverse Proxy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/OSC/ood-documentation/blob/develop/source/how-tos/app-development/interactive/setup/enable-reverse-proxy.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="enable-reverse-proxy">
<span id="app-development-interactive-setup-enable-reverse-proxy"></span><h1><span class="section-number">3. </span>Enable Reverse Proxy<a class="headerlink" href="#enable-reverse-proxy" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="https://en.wikipedia.org/wiki/Reverse_proxy">reverse proxy</a> will proxy a request to any specified host and port through
IP sockets. This can be used to connect to Jupyter notebook servers, RStudio
servers, VNC servers, and more! This is disabled by default as it can be a
security risk if not properly setup using a good <code class="docutils literal notranslate"><span class="pre">host_regex</span></code>.</p>
<p>You can read more about how this works in Open OnDemand under
<a class="reference internal" href="../../../../reference/files/ood-portal-yml.html#ood-portal-generator-configuration-configure-reverse-proxy"><span class="std std-ref">Configure Reverse Proxy</span></a>.</p>
<div class="section" id="requirements">
<h2><span class="section-number">3.1. </span>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>a regular expression that best describes all the hosts that you would want a
user to connect to through the proxy (e.g., <code class="docutils literal notranslate"><span class="pre">[\w.-]+\.osc\.edu</span></code>)</p></li>
<li><p>confirm that if you run the command <code class="docutils literal notranslate"><span class="pre">hostname</span></code> from a compute node it will
return a string that matches the above regular expression</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>hostname
<span class="c1"># n0001.ten.osc.edu</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the <strong class="command">hostname</strong> command gives you a value that cannot be used
to connect to the compute node from the OnDemand host, then you can
override it in the cluster config with a <strong class="command">bash</strong> command that will
work, e.g.:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/ood/config/clusters.d/cluster1.yml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="nt">v2</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Cluster</span><span class="nv"> </span><span class="s">1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">login</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cluster1.my_center.edu&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">job</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">adapter</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;...&quot;</span><span class="w"></span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span><span class="w"></span>
<span class="w">  </span><span class="nt">batch_connect</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">basic</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">script_wrapper</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">        </span><span class="no">module purge</span><span class="w"></span>
<span class="w">        </span><span class="no">%s</span><span class="w"></span>
<span class="hll"><span class="w">      </span><span class="nt">set_host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;host=$(hostname</span><span class="nv"> </span><span class="s">-A</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">awk</span><span class="nv"> </span><span class="s">&#39;{print</span><span class="nv"> </span><span class="s">$1}&#39;)&quot;</span><span class="w"></span>
</span><span class="w">    </span><span class="nt">vnc</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">script_wrapper</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<span class="w">        </span><span class="no">module purge</span><span class="w"></span>
<span class="w">        </span><span class="no">export PATH=&quot;/usr/local/turbovnc/bin:$PATH&quot;</span><span class="w"></span>
<span class="w">        </span><span class="no">export WEBSOCKIFY_CMD=&quot;/usr/local/websockify/run&quot;</span><span class="w"></span>
<span class="w">        </span><span class="no">%s</span><span class="w"></span>
<span class="hll"><span class="w">      </span><span class="nt">set_host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;host=$(hostname</span><span class="nv"> </span><span class="s">-A</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">awk</span><span class="nv"> </span><span class="s">&#39;{print</span><span class="nv"> </span><span class="s">$1}&#39;)&quot;</span><span class="w"></span>
</span></pre></div>
</div>
</div>
</li>
</ul>
</div>
<div class="section" id="steps-to-enable-in-apache">
<h2><span class="section-number">3.2. </span>Steps to Enable in Apache<a class="headerlink" href="#steps-to-enable-in-apache" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>This requires modifying the YAML <a class="reference internal" href="../../../../reference/files/ood-portal-yml.html#ood-portal-generator-configuration"><span class="std std-ref">portal configuration file</span></a>
located at <code class="file docutils literal notranslate"><span class="pre">/etc/ood/config/ood_portal.yml</span></code> as such:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/ood/config/ood_portal.yml</span><span class="w"></span>
<span class="nn">---</span><span class="w"></span>
<span class="hll"><span class="nt">host_regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;[\w.-]+\.my_center\.edu&#39;</span><span class="w"></span>
</span><span class="hll"><span class="nt">node_uri</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/node&#39;</span><span class="w"></span>
</span><span class="hll"><span class="nt">rnode_uri</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/rnode&#39;</span><span class="w"></span>
</span></pre></div>
</div>
<p>You can read more about these options under
<a class="reference internal" href="../../../../reference/files/ood-portal-yml.html#ood-portal-generator-configuration-configure-reverse-proxy"><span class="std std-ref">Configure Reverse Proxy</span></a>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>What if my site foregos the FQDN in the host names for compute nodes, and
we have compute names that give their hosts as:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ab001</span></code> … <code class="docutils literal notranslate"><span class="pre">ab100</span></code> (for the AB cluster)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pn001</span></code> … <code class="docutils literal notranslate"><span class="pre">pn500</span></code> (for the PN cluster)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xy001</span></code> … <code class="docutils literal notranslate"><span class="pre">xy125</span></code> (for the XY cluster)</p></li>
</ul>
<p>You could then use the following regular expression in your configuration
file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">host_regex</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;(ab|pn|xy)\d+&#39;</span><span class="w"></span>
<span class="nt">node_uri</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/node&#39;</span><span class="w"></span>
<span class="nt">rnode_uri</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;/rnode&#39;</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not add start (<code class="docutils literal notranslate"><span class="pre">^</span></code>, <code class="docutils literal notranslate"><span class="pre">A</span></code>) or end (<code class="docutils literal notranslate"><span class="pre">$</span></code>, <code class="docutils literal notranslate"><span class="pre">Z</span></code>) of string/line
anchors as this regular expression will be inserted into another regular
expression.</p>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Failing to add an appropriate regular expression to the Reverse Proxy
opens you up to possible phishing attacks. As a malicious party could
send links to unsuspecting users as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">ondemand</span><span class="o">.</span><span class="n">my_center</span><span class="o">.</span><span class="n">edu</span><span class="o">/</span><span class="n">rnode</span><span class="o">/</span><span class="n">phishing</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="mi">80</span><span class="o">/...</span>
</pre></div>
</div>
<p>And users will implicitly trust the link since it points to the trusting
domain of <code class="docutils literal notranslate"><span class="pre">ondemand.my_center.edu</span></code>.</p>
</div>
</li>
<li><p>Build/install the updated Apache configuration file:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo /opt/ood/ood-portal-generator/sbin/update_ood_portal
</pre></div>
</div>
</li>
<li><p><a class="reference internal" href="../../../debug/debug-apache.html#restart-apache"><span class="std std-ref">Restart the Apache service</span></a> to have the changes take effect:</p></li>
</ol>
</div>
<div class="section" id="verify-it-works">
<h2><span class="section-number">3.3. </span>Verify it Works<a class="headerlink" href="#verify-it-works" title="Permalink to this headline">¶</a></h2>
<p>We can test that the reverse proxy is now functional by starting up a simple
server on a compute node and connecting to it through the proxy with our
browser.</p>
<ol class="arabic">
<li><p>SSH to any compute node that matches the regular expression above:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh n0001.ten.osc.edu
</pre></div>
</div>
</li>
<li><p>Start up a very simple listening server on a high number port:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>nc -l <span class="m">5432</span>
</pre></div>
</div>
</li>
<li><p>In your browser navigate to this server using the Apache reverse proxy with
the following URL format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ondemand</span><span class="o">.</span><span class="n">my_center</span><span class="o">.</span><span class="n">edu</span><span class="o">/</span><span class="n">node</span><span class="o">/&lt;</span><span class="n">host</span><span class="o">&gt;/&lt;</span><span class="n">port</span><span class="o">&gt;/...</span>
</pre></div>
</div>
<p>So for our simplified case lets use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">ondemand</span><span class="o">.</span><span class="n">my_center</span><span class="o">.</span><span class="n">edu</span><span class="o">/</span><span class="n">node</span><span class="o">/</span><span class="n">n0001</span><span class="o">.</span><span class="n">ten</span><span class="o">.</span><span class="n">osc</span><span class="o">.</span><span class="n">edu</span><span class="o">/</span><span class="mi">5432</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p>Go back to your SSH session and verify that it received the browser
request:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>nc -l <span class="m">5432</span>
<span class="c1"># GET /node/n0691.ten.osc.edu/5432/ HTTP/1.1</span>
<span class="c1"># Host: n0691.ten.osc.edu:5432</span>
<span class="c1"># Upgrade-Insecure-Requests: 1</span>
...
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As we don’t have the simple server return anything to the browser, you
can ignore any errors or warnings you see in your browser.</p>
</div>
</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../../customizations.html" class="btn btn-neutral float-right" title="Customizations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="modify-cluster-configuration.html" class="btn btn-neutral float-left" title="2. Modify Cluster Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2023, Ohio Supercomputer Center

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Documentation Versions</span>
    v: 
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      
        <dd><a href="https://OSC.github.io/ood-documentation/latest/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">latest</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-2.0/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">2.0</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.8/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.8</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.7/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.7</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.6/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.6</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.5/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.5</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.4/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.4</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.3/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.3</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.2/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.2</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.1/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.1</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.0/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">1.0</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/develop/how-tos/app-development/interactive/setup/enable-reverse-proxy.html">develop</a></dd>
      
    </dl>
    <dl>
      <dt>On GitHub</dt>
        <dd>
          <a href="http://openondemand.org/">Website</a>
        </dd>
        <dd>
          <a href="https://github.com/OSC/Open-OnDemand">Main Repo</a>
        </dd>
    </dl>
    <hr/>
    Theme provided by <a href="http://www.readthedocs.org">Read the Docs</a>.
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>