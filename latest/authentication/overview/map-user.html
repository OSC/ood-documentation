

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. Setup User Mapping &mdash; Open OnDemand 1.8.12 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3. Configure Logout" href="configure-logout.html" />
    <link rel="prev" title="1. Configure Apache Authentication" href="configure-authentication.html" />
 
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-34776817-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-34776817-3');
</script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">Configuration Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Install</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../authentication.html">Authentication</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../overview.html">Overview</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="configure-authentication.html">1. Configure Apache Authentication</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">2. Setup User Mapping</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#regex-user-mapping">2.1. Regex User Mapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#file-user-mapping">2.2. File User Mapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#custom-mapping">2.3. Custom Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="configure-logout.html">3. Configure Logout</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../oidc.html">OpenID Connect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dex.html">OpenID Connect with Dex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../shibboleth.html">Shibboleth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cas.html">CAS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial-oidc-keycloak-rhel7.html">OpenID Connect with KeyCloak on RHEL7</a></li>
<li class="toctree-l2"><a class="reference internal" href="../duo-2fa-with-keycloak.html">Two Factor Auth using Duo with Keycloak</a></li>
<li class="toctree-l2"><a class="reference internal" href="../adfs-with-auth-mellon.html">SAML Authentication with Active Directory Federated Services (ADFS) and mod_auth_mellon</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pam.html">Add PAM Authentication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/add-cluster-config.html">Add Cluster Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/resource-manager.html">Resource Manager Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../customization_overview.html">Customization Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../customization.html">Customization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analytics.html">Analytics</a></li>
</ul>
<p class="caption"><span class="caption-text">Extend</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../app-development/interactive/setup.html">Setup Interactive Apps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../enable-desktops.html">Enable Interactive Desktop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install-ihpc-apps.html">Install Other Interactive Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Deploy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../app-authorization.html">App Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../app-sharing.html">App Sharing</a></li>
</ul>
<p class="caption"><span class="caption-text">Develop Interactive Apps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../app-development.html">App Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../app-development/tutorials-interactive-apps.html">Tutorials: Interactive Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Develop Passenger Apps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../app-development/tutorials-passenger-apps.html">Tutorials: Passenger Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Release Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.8-release-notes.html">v1.8 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.7-release-notes.html">v1.7 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.6-release-notes.html">v1.6 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.5-release-notes.html">v1.5 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.4-release-notes.html">v1.4 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.3-release-notes.html">v1.3 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.2-release-notes.html">v1.2 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.1-release-notes.html">v1.1 Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release-notes/v1.0-release-notes.html">v1.0 Release Notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Known Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../issues/overview.html">OnDemand’s Known Issues</a></li>
</ul>
<p class="caption"><span class="caption-text">Legacy Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user-documentation.html">User Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Open OnDemand</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../authentication.html">Authentication</a> &raquo;</li>
        
          <li><a href="../overview.html">Overview</a> &raquo;</li>
        
      <li>2. Setup User Mapping</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/OSC/ood-documentation/blob/latest/source/authentication/overview/map-user.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="setup-user-mapping">
<span id="authentication-overview-map-user"></span><h1>2. Setup User Mapping<a class="headerlink" href="#setup-user-mapping" title="Permalink to this headline">¶</a></h1>
<p>Every HTTP request sent to the OnDemand portal triggers a call to the
<code class="docutils literal notranslate"><span class="pre">user_map_cmd</span></code> to map the remote authenticated user name to the
local system user name. Mapping to the local system user not only restricts
access of OnDemand to local users but it is also required by the OnDemand proxy
to traffic the HTTP data to the user’s corresponding per-user NGINX (PUN)
server.</p>
<p>The <a class="reference internal" href="../../reference/commands/ood-portal-generator.html#ood-portal-generator"><span class="std std-ref">ood-portal-generator</span></a> and its corresponding
<a class="reference internal" href="../../reference/files/ood-portal-yml.html#ood-portal-generator-configuration"><span class="std std-ref">ood_portal.yml</span></a> are used to configure both the system
command that performs the mapping (<a class="reference internal" href="../../reference/files/ood-portal-yml.html#ood-portal-generator-user-map-cmd"><span class="std std-ref">user_map_cmd</span></a>) and the argument fed to the system
command (<a class="reference internal" href="../../reference/files/ood-portal-yml.html#ood-portal-generator-user-env"><span class="std std-ref">user_env</span></a>). By default these
configuration options are defined as:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/ood/config/ood_portal.yml</span>
<span class="nn">---</span>
<span class="c1"># ...</span>
<span class="l l-Scalar l-Scalar-Plain">user_map_cmd</span><span class="p p-Indicator">:</span> <span class="s">&#39;/opt/ood/ood_auth_map/bin/ood_auth_map.regex&#39;</span>
<span class="l l-Scalar l-Scalar-Plain">user_env</span><span class="p p-Indicator">:</span> <span class="s">&#39;REMOTE_USER&#39;</span>
</pre></div>
</div>
<p>which uses regex user mapping for the mapping command and <code class="docutils literal notranslate"><span class="pre">REMOTE_USER</span></code>
(this variable holds the name of the authenticated user by the web server) as
its command line argument.</p>
<p>This is equivalent to calling from the command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>/opt/ood/ood_auth_map/bin/ood_auth_map.regex <span class="s2">&quot;</span><span class="nv">$REMOTE_USER</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>which just echos back the value of <code class="docutils literal notranslate"><span class="pre">REMOTE_USER</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The default user mapping employed by an OnDemand portal <strong>directly</strong> maps
the remote authenticated user name to the local user name. So the Apache
authentication module used is expected to set the correct local user name in
<code class="docutils literal notranslate"><span class="pre">REMOTE_USER</span></code>.</p>
</div>
<p>Open OnDemand provides two facilities for user mapping. One through regular
expressions (the default) and another through a lookup file.  Both of which
are documented here.  As an alternative you can provide your own custom script
and simply set the <code class="docutils literal notranslate"><span class="pre">user_map_cmd</span></code> to use it.</p>
<div class="section" id="regex-user-mapping">
<h2>2.1. Regex User Mapping<a class="headerlink" href="#regex-user-mapping" title="Permalink to this headline">¶</a></h2>
<p>Usage for the regular expression (regex) user mapping script is below.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>/opt/ood/ood_auth_map/bin/ood_auth_map.regex <span class="o">[</span>options<span class="o">]</span> &lt;authenticated_user&gt;
</pre></div>
</div>
<p>With the options:</p>
<dl class="option">
<dt id="cmdoption-r">
<code class="descname">-r</code><code class="descclassname"> &lt;regex&gt;</code><code class="descclassname">, </code><code class="descname">--regex</code><code class="descclassname"> &lt;regex&gt;</code><a class="headerlink" href="#cmdoption-r" title="Permalink to this definition">¶</a></dt>
<dd><p>Default: <code class="docutils literal notranslate"><span class="pre">^(.+)$</span></code></p>
<p>The regular expression used to capture the local system username.</p>
</dd></dl>

<div class="section" id="regex-user-mapping-examples">
<h3>2.1.1. Regex User Mapping Examples<a class="headerlink" href="#regex-user-mapping-examples" title="Permalink to this headline">¶</a></h3>
<p>Here are some examples of how to use the default regex mapping script.</p>
<p>To echo back the username supplied (useful for LDAP authentication
and the default behavior):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ /opt/ood/ood_auth_map/bin/ood_auth_map.regex <span class="s1">&#39;bob&#39;</span>
bob
$
</pre></div>
</div>
<p>To capture the local username from an email address.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ /opt/ood/ood_auth_map/bin/ood_auth_map.regex --regex <span class="s1">&#39;^(\w+)@center.edu$&#39;</span> <span class="s1">&#39;bob@center.edu&#39;</span>
bob
$
</pre></div>
</div>
<p>If no match is found from the supplied regular expression and authenticated username
that an empty string is returned instead:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ /opt/ood/ood_auth_map/bin/ood_auth_map.regex --regex <span class="s1">&#39;^(\w+)@center.edu$&#39;</span> <span class="s1">&#39;bob@mit.edu&#39;</span>

$
</pre></div>
</div>
</div>
</div>
<div class="section" id="file-user-mapping">
<h2>2.2. File User Mapping<a class="headerlink" href="#file-user-mapping" title="Permalink to this headline">¶</a></h2>
<p>This script parses a mapfile with each entry given in the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;authenticated_username&quot;</span> <span class="n">local_username</span>
</pre></div>
</div>
<p>and separated by newlines. The script will systematically parse each line in
the mapfile looking for a match to the <code class="docutils literal notranslate"><span class="pre">authenticated_username</span></code>. When a match
is found it breaks from the scan and outputs the <code class="docutils literal notranslate"><span class="pre">local_username</span></code> to
<code class="docutils literal notranslate"><span class="pre">STDOUT</span></code>.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>/opt/ood/ood_auth_map/bin/ood_auth_map.mapfile <span class="o">[</span>OPTIONS<span class="o">]</span> &lt;REMOTE_USER&gt;
</pre></div>
</div>
<p>The options for this script are:</p>
<dl class="option">
<dt id="cmdoption-ood-auth-map-mapfile-f">
<code class="descname">-f</code><code class="descclassname"> &lt;file&gt;</code><code class="descclassname">, </code><code class="descname">--file</code><code class="descclassname"> &lt;file&gt;</code><a class="headerlink" href="#cmdoption-ood-auth-map-mapfile-f" title="Permalink to this definition">¶</a></dt>
<dd><p>Default: <code class="docutils literal notranslate"><span class="pre">/etc/grid-security/grid-mapfile</span></code></p>
<p>File used to scan for matches.</p>
</dd></dl>

<div class="section" id="examples-for-the-mapfile-script">
<h3>2.2.1. Examples for the MapFile script<a class="headerlink" href="#examples-for-the-mapfile-script" title="Permalink to this headline">¶</a></h3>
<p>To scan the default grid-mapfile using a URL-encoded authenticated username:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ /opt/ood/ood_auth_map/bin/ood_auth_map.mapfile <span class="s1">&#39;http%3A%2F%2Fcilogon.org%2FserverA%2Fusers%2F58606%40cilogon.org&#39;</span>
bob
$
</pre></div>
</div>
<p>To scan a custom mapfile using an authenticated username:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ /opt/ood/ood_auth_map/bin/ood_auth_map.mapfile --file <span class="s1">&#39;/path/to/mapfile&#39;</span> <span class="s1">&#39;opaque_remote_username&#39;</span>
bob
$
</pre></div>
</div>
<p>If no match is found within the mapfile for the supplied
authenticated username that an empty string is returned instead:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ /opt/ood/ood_auth_map/bin/ood_auth_map.mapfile <span class="s1">&#39;this_remote_username_does_not_exist&#39;</span>

$
</pre></div>
</div>
</div>
</div>
<div class="section" id="custom-mapping">
<h2>2.3. Custom Mapping<a class="headerlink" href="#custom-mapping" title="Permalink to this headline">¶</a></h2>
<p>As mentioned previously the <a class="reference internal" href="../../reference/commands/ood-portal-generator.html#ood-portal-generator"><span class="std std-ref">ood-portal-generator</span></a> configuration options
of interest are:</p>
<ul class="simple">
<li><a class="reference internal" href="../../reference/files/ood-portal-yml.html#ood-portal-generator-user-map-cmd"><span class="std std-ref">user_map_cmd</span></a></li>
<li><a class="reference internal" href="../../reference/files/ood-portal-yml.html#ood-portal-generator-user-env"><span class="std std-ref">user_env</span></a></li>
</ul>
<p>Indeed if you need to use the options to the regex or file user mapping scripts
that come with Open OnDemand you’ll need to specify them in the <code class="docutils literal notranslate"><span class="pre">user_map_cmd</span></code>.</p>
<p>After modifying <code class="file docutils literal notranslate"><span class="pre">/etc/ood/config/ood_portal.yml</span></code> with the mapping you
want you would then build and install the new Apache configuration file with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo /opt/ood/ood-portal-generator/sbin/update_ood_portal
</pre></div>
</div>
<p>Finally you will need to restart your Apache HTTP Server for the changes to
take effect.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="configure-logout.html" class="btn btn-neutral float-right" title="3. Configure Logout" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="configure-authentication.html" class="btn btn-neutral float-left" title="1. Configure Apache Authentication" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, Ohio Supercomputer Center

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Documentation Versions</span>
    v: 
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Versions</dt>
      
        <dd><a href="https://OSC.github.io/ood-documentation/latest/authentication/overview/map-user.html">latest</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.7/authentication/overview/map-user.html">1.7</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.6/authentication/overview/map-user.html">1.6</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.5/authentication/overview/map-user.html">1.5</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.4/authentication/overview/map-user.html">1.4</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.3/authentication/overview/map-user.html">1.3</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.2/authentication/overview/map-user.html">1.2</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.1/authentication/overview/map-user.html">1.1</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/release-1.0/authentication/overview/map-user.html">1.0</a></dd>
      
        <dd><a href="https://OSC.github.io/ood-documentation/develop/authentication/overview/map-user.html">develop</a></dd>
      
    </dl>
    <dl>
      <dt>On GitHub</dt>
        <dd>
          <a href="http://openondemand.org/">Website</a>
        </dd>
        <dd>
          <a href="https://github.com/OSC/Open-OnDemand">Main Repo</a>
        </dd>
    </dl>
    <hr/>
    Theme provided by <a href="http://www.readthedocs.org">Read the Docs</a>.
  </div>
</div>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>